---
# ─────────────────────────────────────────────────────────────
# Playbook : bootstrap-ssh.yml
# Purpose  : Prepare password-less SSH from the jump host to
#            the AAP node (add key + connectivity test).
# ─────────────────────────────────────────────────────────────

- name: Bootstrap SSH connectivity from Jump Host → AAP Host
  hosts: jump
  gather_facts: false
  vars:
    # ── Connection defaults (override via -e or inventory) ──
    aap_host_ip: "10.0.1.12"
    aap_port: "22"
    aap_target_user: "rheluser"
    aap_target_ssh_key: "/home/rheluser/.ssh/ansible-demo-key"

  tasks:

    # ─────────────────────────────────────────────────────
    # Step 0  – Debug chosen SSH settings
    # ─────────────────────────────────────────────────────
    - name: Debug chosen SSH parameters
      ansible.builtin.debug:
        msg: |
          Will connect to {{ aap_host_ip }}:{{ aap_port | default('22') }}
          as {{ aap_target_user }} using key {{ aap_target_ssh_key }}

    # ─────────────────────────────────────────────────────
    # Step 1  – Scan & record AAP host SSH key
    # (plain key, no hash, no :port for default 22)
    # ─────────────────────────────────────────────────────
    - name: Scan & record AAP host SSH key
      ansible.builtin.known_hosts:
        path: "{{ ansible_user_dir }}/.ssh/known_hosts"
        name: "{{ aap_host_ip }}"
        key: "{{ lookup('pipe', 'ssh-keyscan -T 5 ' + aap_host_ip) }}"
        state: present
        hash_host: no

    # ─────────────────────────────────────────────────────
    # Step 2a – Copy private key (kept exactly as before)
    # ─────────────────────────────────────────────────────
    - name: Copy private key to jump host
      ansible.builtin.copy:
        src: "{{ aap_target_ssh_key }}"
        dest: "{{ ansible_user_dir }}/.ssh/id_rsa"
        mode: '0600'

    # ─────────────────────────────────────────────────────
    # Step 2b – Wait for SSH to respond (network level)
    # ─────────────────────────────────────────────────────
    - name: Wait for SSH port on AAP host
      ansible.builtin.wait_for:
        host: "{{ aap_host_ip }}"
        port: "{{ aap_port | default('22') }}"
        state: started
        timeout: 30
      delegate_to: localhost

    # ─────────────────────────────────────────────────────
    # Step 2c – Test password-less SSH
    # (unchanged from your original working logic)
    # ─────────────────────────────────────────────────────
    - name: Test password-less SSH connectivity
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=yes \
            -i "{{ aap_target_ssh_key }}" \
            -p {{ aap_port | default('22') }} \
            {{ aap_target_user }}@{{ aap_host_ip }} \
            'echo OK'
      register: ssh_test
      changed_when: false
      delegate_to: localhost

    - name: Fail if SSH test did not return OK
      ansible.builtin.fail:
        msg: "Password-less SSH failed."
      when: ssh_test.stdout.strip() != "OK"
